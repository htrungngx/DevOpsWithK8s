image: node:alpine 
variables:
  BUILD_DOCKER_IMAGE: "htrungtodo/docker"
  BUILD_DOCKER_TAG: "v1"
stages:
  - build
  - code scan
  - dockerize
  - image scan
  - deploy

docker-build:
  stage: dockerize
  image:
    name: docker:stable
  services: 
    - name: docker:dind 
      alias: thedockerhost 
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
  script:
    - docker build -t "$BUILD_DOCKER_IMAGE" .
    - docker tag "$BUILD_DOCKER_IMAGE" "$BUILD_DOCKER_IMAGE":latest
    - docker push "$BUILD_DOCKER_IMAGE":latest 